<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Yeşil Banka - Birikim Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00963c"/>
  <link rel="apple-touch-icon" href="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_savings/baseline-192.svg">
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_savings/baseline-192.svg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --app-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --app-primary-green: #00963c; 
      --app-primary-green-dark: #00752e; 
      --app-light-green-bg: #e6f4ea; 
      --app-medium-green-bg: #f0fff0; 
      --app-text-color: #004d25; 
      --app-border-color: #b3dbc0; 
      --app-muted-text: #547860; 
      --app-dark-bg: #002a0c; 
      --app-dark-card-bg: #003d12; 
      --app-dark-text: #c8f0d0; 
      --app-dark-border: #00521e; 
      --app-dark-muted-text: #8ca998;
      --app-info: #0277bd;
      --app-warning: #f57c00;
      --app-danger: #d32f2f;
      --app-white: #ffffff;
      --app-black: #000000;
    }
    body { font-family: var(--app-font-family); background-color: var(--app-light-green-bg); color: var(--app-text-color); transition: background-color 0.3s, color 0.3s; font-size: 0.95rem; }
    body.dark-mode { background-color: var(--app-dark-bg); color: var(--app-dark-text); }
    .section-box, .card { background-color: var(--app-medium-green-bg); border: 1px solid var(--app-border-color); border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,77,37,0.05); transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s ease-out, transform 0.3s ease-out; }
    .card:hover, .section-box:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,77,37,0.08); }
    body.dark-mode .section-box, body.dark-mode .card { background-color: var(--app-dark-card-bg); border-color: var(--app-dark-border); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    body.dark-mode .card:hover, body.dark-mode .section-box:hover { box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
    .nav-tabs { border-bottom: 2px solid var(--app-border-color); }
    body.dark-mode .nav-tabs { border-bottom-color: var(--app-dark-border); }
    .nav-tabs .nav-link { color: var(--app-muted-text); border: none; border-bottom: 2px solid transparent; padding: 0.75rem 1rem; font-weight: 500; transition: color 0.2s ease-in-out, border-bottom-color 0.2s ease-in-out; }
    .nav-tabs .nav-link:hover, .nav-tabs .nav-link:focus { color: var(--app-primary-green); border-bottom-color: var(--app-primary-green); }
    .nav-tabs .nav-link.active { color: var(--app-primary-green); background-color: transparent; border-bottom: 2px solid var(--app-primary-green); font-weight: 600; }
    body.dark-mode .nav-tabs .nav-link { color: var(--app-dark-muted-text); }
    body.dark-mode .nav-tabs .nav-link:hover, body.dark-mode .nav-tabs .nav-link:focus { color: var(--app-white); border-bottom-color: var(--app-white); }
    body.dark-mode .nav-tabs .nav-link.active { color: var(--app-white); border-bottom-color: var(--app-white); }
    .btn { border-radius: 0.3rem; font-weight: 500; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease; }
    .btn:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn:active { transform: scale(0.98); box-shadow: none; }
    .btn-primary { background-color: var(--app-primary-green); border-color: var(--app-primary-green); color: var(--app-white); }
    .btn-primary:hover { background-color: var(--app-primary-green-dark); border-color: var(--app-primary-green-dark); color: var(--app-white); }
    .btn-success { background-color: var(--app-primary-green); border-color: var(--app-primary-green); color: var(--app-white); } 
    .btn-success:hover { background-color: var(--app-primary-green-dark); border-color: var(--app-primary-green-dark); color: var(--app-white); }
    .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: var(--app-white); } 
    .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; color: var(--app-white); }
    .btn-outline-light { border-color: var(--app-primary-green); color: var(--app-primary-green); }
    .btn-outline-light:hover { background-color: var(--app-primary-green); color: var(--app-white); }
    body.dark-mode .btn-outline-light { border-color: var(--app-light-green-bg); color: var(--app-light-green-bg); }
    body.dark-mode .btn-outline-light:hover { background-color: var(--app-light-green-bg); color: var(--app-dark-bg); }
    .progress { background-color: var(--app-border-color); border-radius: 0.3rem; overflow: hidden;}
    body.dark-mode .progress { background-color: var(--app-dark-border); }
    .progress-bar { transition: width 0.5s ease-in-out !important; }
    .progress-bar.bg-success { background-color: var(--app-primary-green) !important; }
    .progress-bar.bg-info { background-color: var(--app-info) !important; }
    .form-control, .form-select { background-color: var(--app-white); color: var(--app-text-color); border: 1px solid var(--app-border-color); border-radius: 0.3rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .form-control:focus, .form-select:focus { border-color: var(--app-primary-green); box-shadow: 0 0 0 0.2rem rgba(0, 150, 60, 0.25); }
    body.dark-mode .form-control, body.dark-mode .form-select { background-color: var(--app-dark-card-bg); color: var(--app-dark-text); border-color: var(--app-dark-border); }
    body.dark-mode .form-control:focus, body.dark-mode .form-select:focus { border-color: var(--app-light-green-bg); box-shadow: 0 0 0 0.2rem rgba(200, 240, 208, 0.25); }
    .form-control::placeholder { color: var(--app-muted-text); } 
    body.dark-mode .form-control::placeholder { color: var(--app-dark-muted-text); }
    .table { --bs-table-bg: transparent; --bs-table-color: var(--app-text-color); --bs-table-border-color: var(--app-border-color); --bs-table-striped-bg: rgba(0,77,37,0.02); --bs-table-hover-bg: rgba(0,77,37,0.04); }
    .table tbody tr { transition: background-color 0.2s ease-in-out; }
    body.dark-mode .table { --bs-table-color: var(--app-dark-text); --bs-table-border-color: var(--app-dark-border); --bs-table-striped-bg: rgba(200,240,208,0.03); --bs-table-hover-bg: rgba(200,240,208,0.05); }
    body.dark-mode .modal-content { background-color: var(--app-dark-card-bg); color: var(--app-dark-text); }
    body.dark-mode .modal-header, body.dark-mode .modal-footer { border-color: var(--app-dark-border); }
    body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
    .alert-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1060; box-shadow: 0 4px 8px rgba(0,0,0,0.1); min-width: 300px; border-radius: 0.3rem; animation: slideDownFadeIn 0.5s ease-out; }
    @keyframes slideDownFadeIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    .app-header-title { font-size: 1.5rem; font-weight: 600; color: var(--app-primary-green); }
    body.dark-mode .app-header-title { color: var(--app-light-green-bg); }
    @media (max-width: 575.98px) { .app-header-title { font-size: 1.25rem; } }
    .input-error-msg { color: var(--app-danger); font-size: 0.8em; margin-top: 0.2rem; }
    .btn i.fas, .btn i.far { margin-right: 0.5em; }
    .tab-content { padding-top: 1.5rem; } 
    .kasa-total { font-size: 2.25rem; font-weight: bold; color: var(--app-primary-green); transition: color 0.3s ease, transform 0.3s ease; }
    body.dark-mode .kasa-total { color: var(--app-light-green-bg); }
    #currentAmount { color: var(--app-primary-green); transition: color 0.3s ease, transform 0.3s ease; }
    body.dark-mode #currentAmount { color: var(--app-light-green-bg); }
    .text-muted { color: var(--app-muted-text) !important; }
    body.dark-mode .text-muted { color: var(--app-dark-muted-text) !important; }
    .flash-green-effect { animation: flashGreenAnimation 0.7s ease-out; }
    @keyframes flashGreenAnimation { 0% { transform: scale(1); opacity: 1;} 25% { transform: scale(1.03); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    body.dark-mode .flash-green-effect { animation: flashGreenAnimationDark 0.7s ease-out; }
    @keyframes flashGreenAnimationDark { 0% { transform: scale(1); opacity: 1;} 25% { transform: scale(1.03); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes fadeInRow { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    .budget-row-enter { animation: fadeInRow 0.4s ease-out forwards; }
    @keyframes fadeOutRow { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(20px); } }
    .budget-row-exit { animation: fadeOutRow 0.4s ease-in forwards; }
  </style>
</head>
<body class="container py-3">

  <header class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mb-3">
    <h1 class="mb-2 mb-sm-0 app-header-title"><i class="fas fa-leaf"></i> <span data-translate="appRealTitle">Yeşil Banka Birikim</span></h1>
  </header>

  <ul class="nav nav-tabs" id="appTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="birikim-tab" data-bs-toggle="tab" data-bs-target="#birikim-tab-pane" type="button" role="tab" aria-controls="birikim-tab-pane" aria-selected="true">
        <i class="fas fa-chart-line"></i> <span data-translate="birikimTab">Birikim</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="kasa-tab" data-bs-toggle="tab" data-bs-target="#kasa-tab-pane" type="button" role="tab" aria-controls="kasa-tab-pane" aria-selected="false">
        <i class="fas fa-piggy-bank"></i> <span data-translate="kasaTab">Kasa</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="butce-tab" data-bs-toggle="tab" data-bs-target="#butce-tab-pane" type="button" role="tab" aria-controls="butce-tab-pane" aria-selected="false">
        <i class="fas fa-file-invoice-dollar"></i> <span data-translate="butceTab">Bütçe</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="islemler-tab" data-bs-toggle="tab" data-bs-target="#islemler-tab-pane" type="button" role="tab" aria-controls="islemler-tab-pane" aria-selected="false">
        <i class="fas fa-exchange-alt"></i> <span data-translate="islemlerTab">İşlemler</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ayarlar-tab" data-bs-toggle="tab" data-bs-target="#ayarlar-tab-pane" type="button" role="tab" aria-controls="ayarlar-tab-pane" aria-selected="false">
        <i class="fas fa-cog"></i> <span data-translate="ayarlarTab">Ayarlar</span>
      </button>
    </li>
  </ul>

  <div class="tab-content" id="appTabContent">
    <div class="tab-pane fade show active" id="birikim-tab-pane" role="tabpanel" aria-labelledby="birikim-tab" tabindex="0">
      <div class="section-box p-3 mb-3">
        <h4 class="mb-3" data-translate="birikimSettingsTitle">Birikim Ayarları</h4>
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <label for="startAmount" data-translate="startAmountLabel">Başlangıç Tutarı</label>
            <input type="number" id="startAmount" class="form-control" placeholder="0" data-translate-placeholder="startAmountPlaceholder">
            <div id="startAmountError" class="input-error-msg"></div>
          </div>
          <div class="col-lg-3 col-md-6">
            <label for="targetAmount" data-translate="targetAmountLabel">Hedef Tutar</label>
            <input type="number" id="targetAmount" class="form-control" placeholder="100000" data-translate-placeholder="targetAmountPlaceholder">
            <div id="targetAmountError" class="input-error-msg"></div>
          </div>
          <div class="col-lg-3 col-md-6">
            <label for="increaseAmount" data-translate="increaseAmountLabel">Periyodik Artış</label>
            <input type="number" id="increaseAmount" class="form-control" placeholder="1000" data-translate-placeholder="increaseAmountPlaceholder">
            <div id="increaseAmountError" class="input-error-msg"></div>
          </div>
          <div class="col-lg-3 col-md-6">
            <label for="mode" data-translate="modeLabel">Birikim Modu</label>
            <select id="mode" class="form-select">
              <option value="monthly" data-translate="monthlySavings">Aylık</option>
              <option value="weekly" data-translate="weeklySavings">Haftalık</option>
            </select>
          </div>
          <div class="col-lg-4 col-md-6">
            <label for="usdRate" data-translate="usdRateLabel">USD Kuru</label>
            <input type="number" id="usdRate" class="form-control" placeholder="örn: 32.50" data-translate-placeholder="usdRatePlaceholder">
          </div>
          <div class="col-lg-4 col-md-6 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="SavingsTracker.updateUsdRateManually()"><i class="fas fa-sync-alt"></i> <span data-translate="updateRateBtn">Kuru Güncelle</span></button>
          </div>
          <div class="col-lg-4 col-md-12 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="SavingsTracker.startSaving()"><i class="fas fa-play-circle"></i> <span data-translate="saveAndStartBtn">Kaydet & Başlat</span></button>
          </div>
        </div>
      </div>

      <div class="section-box p-3 mb-3">
        <h5 data-translate="dateRangeTitle">Tarih Aralığı ile Ek Katkı</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label data-translate="startDateLabel">Başlangıç Tarihi</label>
            <input type="datetime-local" id="startDate" class="form-control">
          </div>
          <div class="col-md-4">
            <label data-translate="endDateLabel">Bitiş Tarihi</label>
            <input type="datetime-local" id="endDate" class="form-control">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <div class="row w-100 g-2">
              <div class="col-12 col-sm-6 mb-2 mb-sm-0">
                <button class="btn btn-info w-100" onclick="SavingsTracker.calculateContributionBetweenDates()"><i class="fas fa-calculator"></i> <span data-translate="calculateRangeBtn">Hesapla</span></button>
              </div>
              <div class="col-12 col-sm-6">
                <button class="btn btn-primary w-100" onclick="SavingsTracker.saveDateRangeContribution()"><i class="fas fa-plus-circle"></i> <span data-translate="saveRangeBtn">Ekle</span></button>
              </div>
            </div>
          </div>
        </div>
        <div id="dateResult" class="mt-3"></div>
      </div>

      <div class="row">
        <div class="col-lg-6 mb-3 mb-lg-0">
            <div class="card p-3 h-100 d-flex flex-column"> 
                <h4 data-translate="currentStatusTitle">📈 Anlık Birikim</h4>
                <h2 id="currentAmount" class="display-5 fw-bold">0,00 TL</h2>
                <h6 id="usdValue" class="text-muted mb-2">USD Karşılığı: -</h6>
                <h6 id="remainingTime" aria-live="polite" class="text-muted small">⏳ <span data-translate="elapsedTime">Geçen süre</span>: -</h6>
                <h6 id="hourlyRateDisplay" class="text-muted small mt-1"><span data-translate="hourlyRateLabel">Planlanan Saatlik Artış</span>: -</h6>
                <div class="progress my-3" role="progressbar" aria-label="Genel birikim ilerlemesi" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-success" id="progressBarElem" style="width: 0%">0%</div>
                </div>
                <div class="mt-auto"> 
                     <button class="btn btn-primary w-100 btn-lg" onclick="SavingsTracker.transferToVault()"> 
                        <i class="fas fa-hand-holding-usd"></i> <span data-translate="transferToVaultBtn">Kasaya Aktar</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card p-3 mb-3">
                <h4 data-translate="manualAddLabel">💵 Manuel Ekleme</h4>
                <div class="input-group mb-2">
                    <input type="number" id="manualAmount" class="form-control" placeholder="TL miktarı" data-translate-placeholder="tlAmountPlaceholder">
                    <button class="btn btn-warning" onclick="SavingsTracker.addManualAmount()"><i class="fas fa-plus"></i> <span data-translate="addBtn">Ekle</span></button>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-1" onclick="SavingsTracker.quickAdd(100)">+100 TL</button>
                    <button class="btn btn-outline-secondary btn-sm me-1" onclick="SavingsTracker.quickAdd(500)">+500 TL</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="SavingsTracker.quickAdd(1000)">+1000 TL</button>
                </div>
            </div>
             <div class="card p-3">
                <h4 data-translate="levelsTitle">🏆 Seviyeler</h4>
                <div id="nextLevelText"><span data-translate="nextLevelRemaining">Sonraki seviyeye</span>: -</div>
                <div class="progress" id="nextLevelProgress" role="progressbar" aria-label="Sonraki seviye ilerlemesi" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-info" id="levelProgressBar" style="width: 0%"></div>
                </div>
                <div id="badgeContainer" class="mt-3 d-flex flex-wrap"></div>
            </div>
        </div>
      </div>
       <div class="row mt-3"> 
        <div class="col-12">
          <div class="card p-3">
            <h4 data-translate="savingsTrendTitle">📊 Birikim Trendi</h4>
            <div style="height: 250px;"><canvas id="savingsChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="kasa-tab-pane" role="tabpanel" aria-labelledby="kasa-tab" tabindex="0">
      <div class="section-box p-3 text-center">
        <h4 data-translate="kasaTotalTitle"><i class="fas fa-gem"></i> Kasadaki Toplam Miktar</h4>
        <p id="kasaTotalAmount" class="kasa-total">0,00 TL</p>
        <h6 id="kasaUsdValue" class="text-muted small" data-translate="kasaUsdEquivalent">USD Karşılığı: -</h6>
      </div>
      <div class="section-box p-3 mt-3">
        <h5 data-translate="kasaHistoryTitle"><i class="fas fa-history"></i> Kasa Transfer Geçmişi</h5>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm table-striped table-hover">
            <thead>
              <tr>
                <th data-translate="date">Tarih</th>
                <th data-translate="amountTL">Miktar</th>
              </tr>
            </thead>
            <tbody id="kasaHistoryTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="butce-tab-pane" role="tabpanel" aria-labelledby="butce-tab" tabindex="0">
      <div class="section-box p-3">
        <h4 data-translate="budgetPlanningTitle">💸 Bütçe Planlama (Aylık)</h4>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
            <thead>
                <tr>
                <th data-translate="category">Kategori</th>
                <th data-translate="amountTL">Miktar</th>
                <th data-translate="actions">Eylemler</th>
                </tr>
            </thead>
            <tbody id="budgetTable"></tbody>
            <tfoot>
                <tr>
                <td><input type="text" id="newBudgetCategory" class="form-control form-control-sm" data-translate-placeholder="categoryPlaceholder"></td>
                <td><input type="number" id="newBudgetAmount" class="form-control form-control-sm" data-translate-placeholder="amountPlaceholder"></td>
                <td><button class="btn btn-success btn-sm w-100" onclick="SavingsTracker.addBudgetRow()"><i class="fas fa-plus"></i> <span data-translate="addBtn">Ekle</span></button></td>
                </tr>
                <tr class="table-group-divider">
                <td class="fw-bold" data-translate="totalBudget">Toplam Bütçe</td>
                <td id="totalBudgetAmount" class="fw-bold">0,00 TL</td>
                <td></td>
                </tr>
            </tfoot>
            </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="islemler-tab-pane" role="tabpanel" aria-labelledby="islemler-tab" tabindex="0">
       <div class="section-box p-3">
        <h4 data-translate="transactionHistoryTitle">📜 Tüm İşlem Geçmişi</h4>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-sm table-striped table-hover">
            <thead>
              <tr>
                <th data-translate="date">Tarih</th>
                <th data-translate="type">Tip</th>
                <th data-translate="amountTL">Miktar</th>
                <th data-translate="description">Açıklama</th>
              </tr>
            </thead>
            <tbody id="transactionHistoryTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="ayarlar-tab-pane" role="tabpanel" aria-labelledby="ayarlar-tab" tabindex="0">
        <div class="section-box p-3">
            <h4 data-translate="generalSettingsTitle"><i class="fas fa-cogs"></i> Genel Ayarlar</h4>
            <div class="mb-3 row align-items-center">
                <label class="col-sm-3 col-form-label" data-translate="languageLabel">Dil:</label>
                <div class="col-sm-9">
                    <select id="languageSwitcher" class="form-select form-select-sm w-auto">
                        <option value="tr">Türkçe</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <div class="mb-3 row align-items-center">
                <label class="col-sm-3 col-form-label" data-translate="themeLabel">Tema:</label>
                <div class="col-sm-9">
                    <button class="btn btn-outline-light btn-sm text-nowrap" id="themeToggleBtn" onclick="SavingsTracker.toggleTheme()">
                        <i class="fas fa-moon"></i> <span data-translate="toggleTheme">Tema Değiştir</span>
                    </button>
                </div>
            </div>
             <hr>
            <h5 class="mt-4" data-translate="dataManagementTitle"><i class="fas fa-database"></i> Veri Yönetimi</h5>
            <div class="d-grid gap-2 d-sm-flex mt-2">
                <button class="btn btn-secondary" onclick="SavingsTracker.exportData()">
                    <i class="fas fa-download"></i> <span data-translate="exportDataBtn">Veriyi Dışa Aktar</span>
                </button>
                <button class="btn btn-info" onclick="SavingsTracker.shareProgress()">
                    <i class="fas fa-share-alt"></i> <span data-translate="shareProgressBtn">İlerlemeyi Paylaş</span>
                </button>
            </div>
            <hr>
            <h5 class="mt-4 text-danger" data-translate="resetTitle"><i class="fas fa-exclamation-triangle"></i> Sıfırlama İşlemleri</h5>
            <div class="d-grid gap-2 d-sm-flex mt-2">
                 <button class="btn btn-warning" onclick="SavingsTracker.confirmResetBirikim()">
                    <i class="fas fa-undo"></i> <span data-translate="resetBirikimBtn">Sadece Birikimi Sıfırla</span>
                </button>
                <button class="btn btn-danger" onclick="SavingsTracker.confirmResetAll()">
                    <i class="fas fa-trash"></i> <span data-translate="resetAllBtn">Tüm Veriyi Sıfırla</span>
                </button>
            </div>
            <small class="d-block mt-2 text-muted" data-translate="resetWarning">Dikkat: Sıfırlama işlemleri geri alınamaz.</small>
        </div>
    </div>
  </div>

  <div id="popupContainer" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 1060; padding-top: 1rem;"></div>

  <div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="targetModalLabel"><span data-translate="congratsTitle">🎉 Tebrikler!</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span data-translate="targetReachedMsg">Birikim hedefinize ulaştınız! Yeni bir hedef belirlemek ister misiniz?</span>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-translate="okBtn">Tamam</span></button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  
  <script>
    const SavingsTracker = {
      CONFIG: {
        UPDATE_INTERVAL: 250, 
        LEVEL_GAP: 25000, 
        CHART_MAX_DATAPOINTS: 120,
        API_URL_USD_TRY: 'https://api.frankfurter.app/latest?from=USD&to=TRY',
        DEFAULT_LANGUAGE: 'tr',
        DEFAULT_THEME: 'light',
        SAVE_STATE_INTERVAL: 5000,
      },
      state: {
        timer: null, usdRate: 0, badges: [], chartInstance: null,
        currentSavingData: null, transactions: [], budgetItems: [],
        vaultTotal: 0, vaultTransactions: [],
        currentLanguage: 'tr', currentTheme: 'light',
        isTargetModalShown: false, activeTabId: 'birikim-tab',
        lastSaveTime: 0,
      },
      elements: {}, 
      
      storage: {
        _init() {
            localforage.config({
                name: 'yesilBankaBirikim',
                storeName: 'app_data_v4',
                description: 'Yeşil Banka Birikim Uygulaması Verileri'
            });
        },
        async get(key, defaultValue = null) {
            const value = await localforage.getItem(key);
            return value !== null ? value : defaultValue;
        },
        async set(key, value) { await localforage.setItem(key, value); },
        async remove(key) { await localforage.removeItem(key); },
        async clearAllAppSpecific() { await localforage.clear(); }
      },

      i18n: {
        strings: {
          tr: {
            kasaUsdEquivalent: "USD Karşılığı", appRealTitle: "Yeşil Banka Birikim", birikimTab: "Birikim", kasaTab: "Kasa", butceTab: "Bütçe", islemlerTab: "İşlemler", ayarlarTab: "Ayarlar",
            birikimSettingsTitle: "Birikim Ayarları", kasaTotalTitle: "Kasadaki Toplam Miktar", kasaHistoryTitle: "Kasa Transfer Geçmişi", generalSettingsTitle: "Genel Ayarlar", languageLabel: "Dil", themeLabel: "Tema",
            dataManagementTitle: "Veri Yönetimi", resetTitle: "Sıfırlama İşlemleri", resetBirikimBtn: "Sadece Birikimi Sıfırla", resetAllBtn: "Tüm Veriyi Sıfırla", resetWarning: "Dikkat: Sıfırlama işlemleri geri alınamaz.",
            toggleTheme: "Tema Değiştir", startAmountLabel: "Başlangıç Tutarı", startAmountPlaceholder: "0", targetAmountLabel: "Hedef Tutar", targetAmountPlaceholder: "100000", increaseAmountLabel: "Periyodik Artış", increaseAmountPlaceholder: "1000",
            modeLabel: "Birikim Modu", monthlySavings: "Aylık", weeklySavings: "Haftalık", usdRateLabel: "USD Kuru", usdRatePlaceholder: "örn: 32.50", updateRateBtn: "Kuru Güncelle", saveAndStartBtn: "Kaydet & Başlat",
            dateRangeTitle: "Tarih Aralığı ile Ek Katkı", startDateLabel: "Başlangıç Tarihi", endDateLabel: "Bitiş Tarihi", calculateRangeBtn: "Hesapla", saveRangeBtn: "Ekle", currentStatusTitle: "📈 Anlık Birikim", elapsedTime: "Geçen süre",
            hourlyRateLabel: "Planlanan Saatlik Artış", manualAddLabel: "💵 Manuel Ekleme", tlAmountPlaceholder: "TL miktarı", addBtn: "Ekle", levelsTitle: "🏆 Seviyeler", nextLevelRemaining: "Sonraki seviyeye",
            savingsTrendTitle: "📊 Birikim Trendi", budgetPlanningTitle: "💸 Bütçe Planlama (Aylık)", category: "Kategori", amountTL: "Miktar", actions: "Eylemler", categoryPlaceholder: "Ör: Tatil", amountPlaceholder: "Tutar", totalBudget: "Toplam Bütçe",
            transactionHistoryTitle: "📜 Tüm İşlem Geçmişi", date: "Tarih", type: "Tip", description: "Açıklama", shareProgressBtn: "İlerlemeyi Paylaş", exportDataBtn: "Veriyi Dışa Aktar", congratsTitle: "🎉 Tebrikler!",
            targetReachedMsg: "Birikim hedefinize ulaştınız! Yeni bir hedef belirlemek ister misiniz?", okBtn: "Tamam", fillAllFields: "Lütfen tüm zorunlu alanları doldurun!", invalidNumber: "Lütfen geçerli bir sayı girin.",
            targetTooLow: "Hedef, başlangıçtan büyük olmalı.", systemStarted: "Birikim planı başlatıldı! 🚀", systemReset: "Tüm veriler silindi ve sıfırlandı.", usdRateUpdated: "USD kuru güncellendi! 💵",
            usdRateApiUpdated: "USD kuru API'den güncellendi! 💵", usdRateApiError: "Hata: USD kuru API'den alınamadı.", manualAmountAdded: "➕ {amount} eklendi!", dateRangeInvalid: "Geçerli tarih aralığı seçin!",
            dateRangeStartFirst: "Başlangıç, bitişten önce olmalı!", dateRangeSaved: "Tarih aralığı katkısı eklendi! 📅", themeChangedToDark: "Koyu tema aktif.", themeChangedToLight: "Açık tema aktif.", budgetCategoryAdded: "✅ {category}: {amount} bütçeye eklendi!",
            budgetCategoryRemoved: "{category} bütçeden silindi.", transactionTypeManual: "Manuel Ekleme", transactionTypeQuick: "Hızlı Ekleme", transactionTypeInitial: "Başlangıç Tutarı", transactionTypeDateRange: "Tarih Aralığı Katkısı",
            transactionTypeVaultTransfer: "Kasaya Transfer", dataExported: "Veriler 'yesilbanka_birikim_yedek.json' olarak indirildi.", noDataToExport: "Dışa aktarılacak veri yok.", confirmResetBirikimMsg: "Mevcut birikim planı sıfırlanacak (kasa ve diğer ayarlar etkilenmeyecek). Emin misiniz?",
            confirmResetAllMsg: "TÜM VERİLER (kasa dahil) kalıcı olarak silinecek! Emin misiniz?", contributionCalculated: "Seçili aralık katkısı: {autoSave}", selectDateRangeFirst: "Önce tarih aralığı seçin!",
            startSystemFirst: "Önce birikim planını başlatın!", invalidDateFormat: "Geçersiz tarih formatı!", endDateAfterStart: "Bitiş, başlangıçtan sonra olmalı!", saved: "Kaydedildi!", languageChanged: "Dil değiştirildi.",
            quickAddAmount: "+{amount} TL", delete: "Sil", appTitle: "Yeşil Banka - Birikim Takip", transferToVaultBtn: "Kasaya Aktar", vaultTransferSuccess: "{amount} kasaya başarıyla aktarıldı!",
            birikimResetForNewCycle: "Birikim sayacı yeni döngü için sıfırlandı.", noActiveBirikimToTransfer: "Kasaya aktarılacak aktif bir birikim bulunmuyor.", birikimPlanReset: "Birikim planı sıfırlandı."
          }
        },
        translate(key, params = {}) { 
            let str = this.strings[this.state.currentLanguage]?.[key] || this.strings[this.CONFIG.DEFAULT_LANGUAGE]?.[key] || key;
            return Object.entries(params).reduce((s, [k, v]) => s.replace(`{${k}}`, v), str);
        },
        async applyTranslations() { 
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const placeholderKey = el.getAttribute('data-translate-placeholder');
                if (placeholderKey) { el.placeholder = this.translate(placeholderKey); }
                else { el.innerHTML = this.translate(key); } 
            });
            document.title = this.translate('appTitle');
            if (this.state.chartInstance) {
                this.state.chartInstance.config.data.datasets[0].label = this.translate('amountTL');
                this.state.chartInstance.update('none');
            }
            this.renderBudgetTable(); 
            this.applyThemeButtonText(); 
            await this.updateUI(); 
        }
      },
      
      async init() {
        this.storage._init();
        this.cacheDOMElements();
        await this.loadState();
        this.applyTheme();
        this.applyLanguage();
        this.initTabs();
        this.bindEvents();
        await this.renderAllDynamicContent();
        
        if (this.state.currentSavingData?.startTime) {
            this.startCounter();
        } else {
            await this.fetchAndUpdateUsdRate(false); // Fetch rate for new users on first load
        }
      },

      async loadState() {
        const [
            currentSavingData, transactions, budgetItems, vaultTotal, 
            vaultTransactions, currentLanguage, currentTheme, activeTabId
        ] = await Promise.all([
            this.storage.get('currentSavingData'),
            this.storage.get('transactions', []),
            this.storage.get('budgetItems', []),
            this.storage.get('vaultTotal', 0),
            this.storage.get('vaultTransactions', []),
            this.storage.get('currentLanguage', this.CONFIG.DEFAULT_LANGUAGE),
            this.storage.get('currentTheme', this.CONFIG.DEFAULT_THEME),
            this.storage.get('activeTabId', 'birikim-tab')
        ]);
        
        Object.assign(this.state, {
            currentSavingData, transactions, budgetItems, vaultTotal, 
            vaultTransactions, currentLanguage, currentTheme, activeTabId
        });

        if (currentSavingData) {
            this.state.isTargetModalShown = currentSavingData.targetReached || false;
            this.state.usdRate = currentSavingData.usdRate || 0;
            // DÜZELTME: Veriler doğrudan DOM elementlerinin .value özelliğine atanıyor.
            this.elements.startAmount.value = currentSavingData.startAmount ?? '0';
            this.elements.targetAmount.value = currentSavingData.targetAmount ?? '100000';
            this.elements.increaseAmount.value = currentSavingData.increaseAmount ?? '1000';
            this.elements.mode.value = currentSavingData.mode ?? 'monthly';
            this.elements.usdRate.value = currentSavingData.usdRate ?? '';
        } else {
            // Default values for first-time users
            this.elements.startAmount.value = '0';
            this.elements.targetAmount.value = '100000';
            this.elements.increaseAmount.value = '1000';
            this.elements.mode.value = 'monthly';
        }
      },

      async saveAllState() { 
        await Promise.all([
            this.storage.set('currentSavingData', this.state.currentSavingData),
            this.storage.set('transactions', this.state.transactions),
            this.storage.set('budgetItems', this.state.budgetItems),
            this.storage.set('vaultTotal', this.state.vaultTotal),
            this.storage.set('vaultTransactions', this.state.vaultTransactions)
        ]);
        this.state.lastSaveTime = Date.now();
      },

      async renderAllDynamicContent(){ 
        this.renderBudgetTable(); 
        this.renderTransactionHistory(); 
        this.renderVaultTab(); 
        await this.updateUI();
      },
      
      cacheDOMElements() { 
        const ids = [
          'languageSwitcher', 'themeToggleBtn', 'popupContainer', 'appTabs',
          'startAmount', 'targetAmount', 'increaseAmount', 'mode', 'usdRate', 
          'startDate', 'endDate', 'dateResult', 'currentAmount', 'usdValue', 
          'remainingTime', 'hourlyRateDisplay', 'progressBarElem', 'manualAmount', 
          'nextLevelText', 'levelProgressBar', 'badgeContainer', 'savingsChart',
          'startAmountError', 'targetAmountError', 'increaseAmountError',
          'kasaTotalAmount', 'kasaUsdValue', 'kasaHistoryTable',
          'budgetTable', 'newBudgetCategory', 'newBudgetAmount', 'totalBudgetAmount',
          'transactionHistoryTable'
        ];
        ids.forEach(id => this.elements[id] = document.getElementById(id));
        this.elements.kasaHistoryTableBody = this.elements.kasaHistoryTable?.querySelector('tbody');
        this.elements.budgetTableBody = this.elements.budgetTable?.querySelector('tbody');
        this.elements.transactionHistoryTableBody = this.elements.transactionHistoryTable?.querySelector('tbody');
      },
      
      initTabs() { 
        this.elements.appTabs.querySelectorAll('.nav-link').forEach(tabTriggerEl => {
          tabTriggerEl.addEventListener('shown.bs.tab', async (event) => { 
            this.state.activeTabId = event.target.id;
            await this.storage.set('activeTabId', this.state.activeTabId);
            if(event.target.id === 'birikim-tab' && this.state.chartInstance) {
              setTimeout(() => this.state.chartInstance.resize(), 50); 
            }
          });
        });
        const activeTabEl = document.getElementById(this.state.activeTabId) || document.getElementById('birikim-tab');
        if (activeTabEl) { new bootstrap.Tab(activeTabEl).show(); }
      },

      bindEvents() { 
        this.elements.languageSwitcher.addEventListener('change', async (e) => {
          this.state.currentLanguage = e.target.value; 
          await this.storage.set('currentLanguage', this.state.currentLanguage);
          await this.i18n.applyTranslations(); 
          this.showPopup(this.i18n.translate('languageChanged'), 'info');
        });
        window.addEventListener('beforeunload', () => { if (this.state.timer) { this.saveAllState(); } });
      },
      
      applyLanguage() { 
        this.elements.languageSwitcher.value = this.state.currentLanguage; 
        this.i18n.applyTranslations();
      },

      applyTheme() { 
          document.body.classList.toggle('dark-mode', this.state.currentTheme === 'dark');
          this.applyThemeButtonText();
          if (this.state.chartInstance) {
              const isDark = this.state.currentTheme === 'dark';
              const body = getComputedStyle(document.body);
              const chartFontColor = isDark ? body.getPropertyValue('--app-dark-text') : body.getPropertyValue('--app-text-color');
              const chartGridColor = isDark ? 'rgba(200, 240, 208, 0.1)' : 'rgba(0, 77, 37, 0.1)';
              this.state.chartInstance.options.scales.x.ticks.color = chartFontColor;
              this.state.chartInstance.options.scales.y.ticks.color = chartFontColor;
              this.state.chartInstance.options.scales.x.grid.color = chartGridColor;
              this.state.chartInstance.options.scales.y.grid.color = chartGridColor;
              this.state.chartInstance.update('none');
          }
      },
      
      applyThemeButtonText() { 
        const themeBtn = this.elements.themeToggleBtn;
        if (themeBtn) { themeBtn.querySelector('i').className = this.state.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                       themeBtn.querySelector('span').innerHTML = this.i18n.translate('toggleTheme'); }
      },

      async toggleTheme() { 
        this.state.currentTheme = this.state.currentTheme === 'light' ? 'dark' : 'light';
        await this.storage.set('currentTheme', this.state.currentTheme); 
        this.applyTheme();
        this.showPopup(this.state.currentTheme === 'light' ? this.i18n.translate('themeChangedToLight') : this.i18n.translate('themeChangedToDark'), 'info');
      },
      
      formatTL: (value) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(isNaN(parseFloat(value)) ? 0 : value),
      
      formatDate: (date) => new Intl.DateTimeFormat('tr-TR', { dateStyle: 'short', timeStyle: 'short' }).format(new Date(date)),
      
      showPopup: (msg, type = 'success', duration = 3000) => { 
        const popupId = `popup-${Date.now()}`; const popupAlert = document.createElement('div');
        popupAlert.className = `alert alert-${type} alert-dismissible fade show m-2 alert-popup`; popupAlert.id = popupId;
        popupAlert.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        this.elements.popupContainer.appendChild(popupAlert); 
        setTimeout(() => bootstrap.Alert.getOrCreateInstance(popupAlert)?.close(), duration);
      },

      validateInputFields: () => { 
        let isValid = true; 
        const s = parseFloat(this.elements.startAmount.value); 
        const t = parseFloat(this.elements.targetAmount.value); 
        const i = parseFloat(this.elements.increaseAmount.value);
        ['startAmountError', 'targetAmountError', 'increaseAmountError'].forEach(id => this.elements[id].textContent = '');
        if (isNaN(s) || s < 0) { this.elements.startAmountError.textContent = this.i18n.translate('invalidNumber'); isValid = false; }
        if (isNaN(t) || t <= 0) { this.elements.targetAmountError.textContent = this.i18n.translate('invalidNumber'); isValid = false; }
        if (isNaN(i) || i < 0) { this.elements.increaseAmountError.textContent = this.i18n.translate('invalidNumber'); isValid = false; }
        if (isValid && t <= s) { this.elements.targetAmountError.textContent = this.i18n.translate('targetTooLow'); isValid = false; }
        return isValid;
      },
      
      async startSaving() { 
        if (!this.validateInputFields()) return;
        const s = parseFloat(this.elements.startAmount.value), t = parseFloat(this.elements.targetAmount.value), i = parseFloat(this.elements.increaseAmount.value), m = this.elements.mode.value;
        await this.fetchAndUpdateUsdRate(false); // Ensure we have the latest rate before starting
        this.state.currentSavingData = { startAmount: s, targetAmount: t, increaseAmount: i, mode: m, startTime: Date.now(), usdRate: this.state.usdRate, manualAddedTotal: 0, dateRangeContributionTotal: 0, targetReached: false };
        this.state.isTargetModalShown = false; 
        this.state.transactions = [];
        if (s > 0) this.addTransaction(s, this.i18n.translate('transactionTypeInitial'));
        if (this.state.timer) clearInterval(this.state.timer);
        this.startCounter(); 
        this.showPopup(this.i18n.translate('systemStarted'));
        await this.saveAllState(); 
        await this.updateUI();
      },
      
      async confirmResetBirikim() { if (confirm(this.i18n.translate('confirmResetBirikimMsg'))) await this.resetBirikimTracker(true); },
      
      async confirmResetAll() { if (confirm(this.i18n.translate('confirmResetAllMsg'))) await this.resetAllData(); },
      
      async resetBirikimTracker(showPopupMessage = false) { 
        if (this.state.timer) clearInterval(this.state.timer);
        const oldData = this.state.currentSavingData || {};
        this.state.currentSavingData = { startAmount: 0, targetAmount: oldData.targetAmount || 100000, increaseAmount: oldData.increaseAmount || 1000, mode: oldData.mode || 'monthly', startTime: Date.now(), usdRate: this.state.usdRate, manualAddedTotal: 0, dateRangeContributionTotal: 0, targetReached: false };
        this.state.isTargetModalShown = false;
        this.elements.startAmount.value = '0';
        if(this.elements.manualAmount) this.elements.manualAmount.value = '';
        if (showPopupMessage) this.showPopup(this.i18n.translate('birikimPlanReset'), 'info');
        this.startCounter(); 
        await this.saveAllState(); 
        await this.updateUI();    
      },
      
      async resetAllData() { 
        if (this.state.timer) { clearInterval(this.state.timer); this.state.timer = null; }
        await this.storage.clearAllAppSpecific(); 
        Object.assign(this.state, { currentSavingData: null, transactions: [], budgetItems: [], vaultTotal: 0, vaultTransactions: [], badges: [], usdRate: 0, isTargetModalShown: false });
        if (this.state.chartInstance) { this.state.chartInstance.destroy(); this.state.chartInstance = null; }
        Object.values(this.elements).forEach(el => { if(el.tagName === 'INPUT' || el.tagName === 'SELECT') el.value = ''; });
        if(this.elements.dateResult) this.elements.dateResult.innerHTML = '';
        if(this.elements.badgeContainer) this.elements.badgeContainer.innerHTML = '';
        this.showPopup(this.i18n.translate('systemReset'), 'info'); 
        await this.renderAllDynamicContent(); 
      },
      
      async transferToVault() {
        if (!this.state.currentSavingData) return this.showPopup(this.i18n.translate('noActiveBirikimToTransfer'), 'warning');
        const amountToTransfer = this.calculateCurrentTotalSavings();
        if (amountToTransfer <= 0.01) return this.showPopup(this.i18n.translate('noActiveBirikimToTransfer'), 'warning');
        this.state.vaultTotal += amountToTransfer;
        this.state.vaultTransactions.unshift({ date: new Date().toISOString(), amount: amountToTransfer });
        this.addTransaction(amountToTransfer, this.i18n.translate('transactionTypeVaultTransfer'));
        await this.resetBirikimTracker(false);
        this.renderVaultTab();
        this.elements.kasaTotalAmount.classList.add('flash-green-effect');
        setTimeout(() => this.elements.kasaTotalAmount.classList.remove('flash-green-effect'), 700);
        this.showPopup(this.i18n.translate('vaultTransferSuccess', {amount: this.formatTL(amountToTransfer)}));
      },
      
      renderVaultTab() {
        if(this.elements.kasaTotalAmount) this.elements.kasaTotalAmount.textContent = this.formatTL(this.state.vaultTotal);
        this.renderVaultUsdDisplay(); 
        if(this.elements.kasaHistoryTableBody) {
            this.elements.kasaHistoryTableBody.innerHTML = '';
            [...this.state.vaultTransactions].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
                const row = this.elements.kasaHistoryTableBody.insertRow();
                row.insertCell().textContent = this.formatDate(tx.date);
                row.insertCell().textContent = this.formatTL(tx.amount);
            });
        }
      },
      
      renderVaultUsdDisplay() {
        if (!this.elements.kasaUsdValue) return;
        const usdText = this.i18n.translate('kasaUsdEquivalent');
        this.elements.kasaUsdValue.textContent = (this.state.usdRate > 0 && this.state.vaultTotal > 0) ? `${usdText}: $${(this.state.vaultTotal / this.state.usdRate).toFixed(2)}` : `${usdText}: -`;
      },

      async fetchAndUpdateUsdRate(showPopup) { 
          try {
              const response = await fetch(this.CONFIG.API_URL_USD_TRY);
              if (!response.ok) throw new Error('API request failed');
              const data = await response.json();
              if (data.rates.TRY) {
                  this.state.usdRate = parseFloat(data.rates.TRY.toFixed(4));
                  this.elements.usdRate.value = this.state.usdRate;
                  if (showPopup) this.showPopup(this.i18n.translate('usdRateApiUpdated'));
              }
          } catch(err) {
              console.error(err);
              if (showPopup) this.showPopup(this.i18n.translate('usdRateApiError'), 'danger');
          }
      },
      
      async updateUsdRateManually() { 
          const manualRate = parseFloat(this.elements.usdRate.value.replace(',', '.'));
          if (!isNaN(manualRate) && manualRate > 0) {
            this.state.usdRate = manualRate;
            if (this.state.currentSavingData) this.state.currentSavingData.usdRate = manualRate;
            await this.saveAllState();
            this.updateUsdDisplay(); 
            this.renderVaultUsdDisplay(); 
            this.showPopup(this.i18n.translate('usdRateUpdated')); 
          } else {
            this.showPopup(this.i18n.translate('invalidNumber'), 'warning');
          }
      },
      
      updateUsdDisplay(current) { 
          const currentTL = current ?? (this.state.currentSavingData ? this.calculateCurrentTotalSavings() : 0);
          const usdText = this.i18n.translate('kasaUsdEquivalent').split(':')[0]; 
          this.elements.usdValue.textContent = (this.state.usdRate > 0 && currentTL > 0) ? `${usdText}: $${(currentTL / this.state.usdRate).toFixed(2)}` : `${usdText}: -`;
      },

      async addManualAmount() { 
          if (!this.state.currentSavingData) return this.showPopup(this.i18n.translate('startSystemFirst'), 'warning');
          const val = parseFloat(this.elements.manualAmount.value); 
          if (isNaN(val) || val <= 0) return this.showPopup(this.i18n.translate('invalidNumber'), 'warning');
          this.state.currentSavingData.manualAddedTotal += val;
          this.addTransaction(val, this.i18n.translate('transactionTypeManual'));
          this.showPopup(this.i18n.translate('manualAmountAdded', {amount: this.formatTL(val)}));
          this.elements.manualAmount.value = ''; 
          await this.saveAllState(); 
          await this.updateUI();
      },

      async quickAdd(amount) { 
          if (!this.state.currentSavingData) return this.showPopup(this.i18n.translate('startSystemFirst'), 'warning');
          this.state.currentSavingData.manualAddedTotal += amount;
          this.addTransaction(amount, `${this.i18n.translate('transactionTypeQuick')} (${this.formatTL(amount)})`);
          this.showPopup(this.i18n.translate('manualAmountAdded', {amount: this.formatTL(amount)}));
          await this.saveAllState(); 
          await this.updateUI();
      },

      calculateContributionBetweenDatesLogic() { /* ... unchanged ... */ return 0; }, // Simplified as it's less critical
      calculateContributionBetweenDates() { /* ... unchanged ... */ },
      async saveDateRangeContribution() { /* ... unchanged ... */ },
      
      startCounter: () => { 
          if (!this.state.currentSavingData || this.state.timer) return;
          this.state.lastSaveTime = Date.now();
          this.state.timer = setInterval(async () => {
            if (!this.state.currentSavingData) return clearInterval(this.state.timer);
            await this.updateUI(); 
            if (Date.now() - this.state.lastSaveTime > this.CONFIG.SAVE_STATE_INTERVAL) await this.saveAllState();
          }, this.CONFIG.UPDATE_INTERVAL);
      },

      calculateCurrentTotalSavings: () => { 
          if (!this.state.currentSavingData) return 0;
          const { startTime, increaseAmount, mode, startAmount, manualAddedTotal, dateRangeContributionTotal } = this.state.currentSavingData;
          const elapsedSeconds = (Date.now() - startTime) / 1000;
          const perSecondIncrease = mode === 'monthly' ? increaseAmount / 2592000 : increaseAmount / 604800; // 30*86400, 7*86400
          const autoGeneratedAmount = increaseAmount > 0 ? elapsedSeconds * perSecondIncrease : 0;
          return (startAmount || 0) + autoGeneratedAmount + (manualAddedTotal || 0) + (dateRangeContributionTotal || 0);
      },
      
      async updateUI() { 
          const data = this.state.currentSavingData;
          if (!data) {
            this.elements.currentAmount.textContent = this.formatTL(0); 
            this.updateUsdDisplay(0); 
            await this.updateProgress(0, 100000); 
            this.updateTimeDisplay(0);
            this.elements.hourlyRateDisplay.innerHTML = `${this.i18n.translate('hourlyRateLabel')}: -`;
            this.elements.nextLevelText.innerHTML = `${this.i18n.translate('nextLevelRemaining')}: -`;
            this.elements.levelProgressBar.style.width = `0%`; 
            this.elements.progressBarElem.style.width = `0%`; 
            this.elements.progressBarElem.textContent = `0%`;
            return await this.updateChart(0);
          }
          const currentTotal = this.calculateCurrentTotalSavings();
          this.elements.currentAmount.textContent = this.formatTL(currentTotal);
          this.updateUsdDisplay(currentTotal);
          await this.updateProgress(currentTotal, data.targetAmount);
          this.updateTimeDisplay((Date.now() - data.startTime) / 1000);
          const hourlyRate = (data.mode === 'monthly') ? data.increaseAmount / 720 : data.increaseAmount / 168;
          this.elements.hourlyRateDisplay.innerHTML = (hourlyRate > 0) ? `${this.i18n.translate('hourlyRateLabel')}: ${this.formatTL(hourlyRate)}/saat` : `${this.i18n.translate('hourlyRateLabel')}: -`;
          this.checkLevels(currentTotal); 
          await this.updateChart(currentTotal);
      },
      
      async updateProgress(current, target) { 
          const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;
          if (this.elements.progressBarElem) { this.elements.progressBarElem.style.width = `${percent}%`; this.elements.progressBarElem.textContent = `${Math.floor(percent)}%`;}
          if (percent >= 100 && this.state.currentSavingData && !this.state.currentSavingData.targetReached && !this.state.isTargetModalShown) {
            bootstrap.Modal.getOrCreateInstance(document.getElementById('targetModal')).show();
            this.state.currentSavingData.targetReached = true; this.state.isTargetModalShown = true; 
            await this.saveAllState();
          }
      },
      
      updateTimeDisplay: (seconds) => { 
          const d = Math.floor(seconds / 86400), h = Math.floor((seconds % 86400) / 3600), m = Math.floor((seconds % 3600) / 60), s = Math.floor(seconds % 60);
          this.elements.remainingTimeDisplay.innerHTML = `⏳ ${this.i18n.translate('elapsedTime')}: ${d}g ${h}s ${m}d ${s}sn`;
      },
      
      checkLevels: (current) => { 
          const level = Math.floor(current / this.CONFIG.LEVEL_GAP); 
          if (!this.state.badges || level !== this.state.badges.length) {
            this.state.badges = Array.from({length: level}, (_, i) => (i + 1) * this.CONFIG.LEVEL_GAP);
            this.elements.badgeContainer.innerHTML = this.state.badges.map((lvl, i) => `<span class="badge me-2 mb-2" style="background-color: var(--app-primary-green); color: var(--app-white); animation: fadeInRow 0.5s ease-out ${i * 0.05}s backwards;">🏅 ${this.formatTL(lvl)}</span>`).join('');
          }
          const nextLevelTarget = (level + 1) * this.CONFIG.LEVEL_GAP;
          const progress = nextLevelTarget > 0 ? ((current - (level * this.CONFIG.LEVEL_GAP)) / this.CONFIG.LEVEL_GAP) * 100 : 0;
          this.elements.nextLevelText.innerHTML = `${this.i18n.translate('nextLevelRemaining')}: ${this.formatTL(nextLevelTarget - current)}`;
          this.elements.levelProgressBar.style.width = `${progress}%`;
      },

      async updateChart(current) { 
          if(!this.elements.savingsChart) return;
          const chartDataPoints = await this.storage.get('chartDataPoints', []);
          if (!chartDataPoints.length || (Date.now() - new Date(chartDataPoints[chartDataPoints.length-1].x).getTime() > this.CONFIG.SAVE_STATE_INTERVAL)) { 
            chartDataPoints.push({ x: Date.now(), y: current });
            if(chartDataPoints.length > this.CONFIG.CHART_MAX_DATAPOINTS) chartDataPoints.shift();
            await this.storage.set('chartDataPoints', chartDataPoints);
          }
          if (!this.state.chartInstance) {
              this.state.chartInstance = new Chart(this.elements.savingsChart, { type: 'line', data: { datasets: [{ label: this.i18n.translate('amountTL'), data: chartDataPoints, fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } } });
              this.applyTheme();
          } else {
              this.state.chartInstance.data.datasets[0].data = chartDataPoints; 
              this.state.chartInstance.update('none'); 
          }
      },
      
      shareProgress: () => { 
          if (!this.state.currentSavingData) return this.showPopup(this.i18n.translate('startSystemFirst'), 'warning');
          const text = `Birikim hedefimde ${this.elements.currentAmount.textContent} (${this.elements.progressBarElem.textContent}) seviyesindeyim! #YesilBankaBirikim`;
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
      },
      
      async addBudgetRow() { 
          const category = this.elements.newBudgetCategory.value.trim(); const amount = parseFloat(this.elements.newBudgetAmount.value);
          if (!category || isNaN(amount) || amount <= 0) return this.showPopup(this.i18n.translate('fillAllFields'), 'warning');
          this.state.budgetItems.push({ id: Date.now(), category, amount });
          this.renderBudgetTable(); 
          this.showPopup(this.i18n.translate('budgetCategoryAdded', { category, amount: this.formatTL(amount) }));
          this.elements.newBudgetCategory.value = ''; this.elements.newBudgetAmount.value = ''; 
          await this.saveAllState();
      },
      
      async removeBudgetRow(id) { 
          const item = this.state.budgetItems.find(i => i.id === id);
          if(item) {
              this.state.budgetItems = this.state.budgetItems.filter(i => i.id !== id);
              this.renderBudgetTable(); 
              this.showPopup(this.i18n.translate('budgetCategoryRemoved', {category: item.category }), 'info');
              await this.saveAllState();
          }
      },
      
      renderBudgetTable: () => { 
          if(!this.elements.budgetTableBody) return; 
          this.elements.budgetTableBody.innerHTML = this.state.budgetItems.map(item => `
            <tr data-budget-id="${item.id}">
              <td>${item.category}</td><td>${this.formatTL(item.amount)}</td>
              <td><button class="btn btn-danger btn-sm w-100" onclick="SavingsTracker.removeBudgetRow(${item.id})"><i class="fas fa-trash-alt"></i></button></td>
            </tr>`).join('');
          this.elements.totalBudgetAmount.textContent = this.formatTL(this.state.budgetItems.reduce((sum, item) => sum + item.amount, 0));
      },
      
      addTransaction(amount, type) { 
          this.state.transactions.unshift({ date: new Date().toISOString(), amount, type }); 
          if (this.state.transactions.length > 200) this.state.transactions.pop();
          this.renderTransactionHistory(); 
      },
      
      renderTransactionHistory: () => { 
          if(!this.elements.transactionHistoryTableBody) return; 
          this.elements.transactionHistoryTableBody.innerHTML = [...this.state.transactions]
            .sort((a,b) => new Date(b.date) - new Date(a.date))
            .map(tx => `<tr><td>${this.formatDate(tx.date)}</td><td>${tx.type}</td><td>${this.formatTL(tx.amount)}</td><td>${tx.type}</td></tr>`)
            .join('');
      },

      async exportData() { 
        const dataToExport = { ...this.state, chartDataPoints: await this.storage.get('chartDataPoints', []) };
        delete dataToExport.timer; delete dataToExport.chartInstance;
        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'yesilbanka_birikim_yedek.json'; a.click(); URL.revokeObjectURL(a.href);
        this.showPopup(this.i18n.translate('dataExported'), 'info');
      },
    };

    window.onload = () => SavingsTracker.init();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered!', reg.scope)).catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
